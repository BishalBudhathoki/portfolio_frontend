version: 1
frontend:
  phases:
    preBuild:
      commands:
        - cd frontend
        - npm ci
        # Create frontend env file
        - |
          cat << EOF > .env.local
          NEXT_PUBLIC_API_URL=${NEXT_PUBLIC_API_URL}
          NEXT_PUBLIC_SITE_URL=${NEXT_PUBLIC_SITE_URL}
          EOF
    build:
      commands:
        - npm run build
  artifacts:
    baseDirectory: frontend/.next
    files:
      - '**/*'
  cache:
    paths:
      - node_modules/**/*

backend:
  phases:
    preBuild:
      commands:
        - cd backend
        - python -m pip install --upgrade pip
        - pip install -r requirements.txt
        # Create backend env file and credentials
        - |
          cat << EOF > .env
          LINKEDIN_USERNAME=${LINKEDIN_USERNAME}
          LINKEDIN_PASSWORD=${LINKEDIN_PASSWORD}
          EOF
        # Create credentials directory and save Google credentials
        - mkdir -p credentials
        - echo ${GOOGLE_SHEETS_CREDENTIALS} | base64 -d > credentials/google_credentials.json
    build:
      commands:
        - echo "Skipping tests during build"
    postBuild:
      commands:
        - echo "Backend setup complete"
  artifacts:
    baseDirectory: backend
    files:
      - '**/*'
    discard-paths: no
  cache:
    paths:
      - /root/.cache/pip

appRoot:
  phases:
    build:
      commands:
        - echo "Creating start script"
        - |
          cat << EOF > start.sh
          #!/bin/bash
          # Start the FastAPI backend
          cd backend
          export LINKEDIN_USERNAME=${LINKEDIN_USERNAME}
          export LINKEDIN_PASSWORD=${LINKEDIN_PASSWORD}
          export GOOGLE_SHEETS_CREDENTIALS_PATH=./credentials/google_credentials.json
          gunicorn -w 4 -k uvicorn.workers.UvicornWorker app.main:app --bind 0.0.0.0:8000 &
          
          # Start the Next.js frontend
          cd ../frontend
          export NEXT_PUBLIC_API_URL=${NEXT_PUBLIC_API_URL}
          export NEXT_PUBLIC_SITE_URL=${NEXT_PUBLIC_SITE_URL}
          npm start
          EOF
        - chmod +x start.sh
  artifacts:
    baseDirectory: /
    files:
      - start.sh 